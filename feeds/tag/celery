<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Michael Jay Lissner</title><link href="http://michaeljaylissner.com/" rel="alternate"></link><link href="http://michaeljaylissner.com/feeds/tag/celery" rel="self"></link><id>http://michaeljaylissner.com/</id><updated>2014-11-01T00:00:00-07:00</updated><entry><title>Some Thoughts on Celery</title><link href="http://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/" rel="alternate"></link><updated>2014-11-01T00:00:00-07:00</updated><author><name>Mike Lissner</name></author><id>tag:michaeljaylissner.com,2014-11-01:posts/2014/11/01/some-thoughts-on-celery/</id><summary type="html">
&lt;p&gt;We finally upgraded &lt;a href="https://www.courtlistener.com"&gt;CourtListener&lt;/a&gt; last week and things went pretty well with the exception of two issues. First, we had some extended downtime as we waited for the database migration to complete. In retrospect, I should have realized that updating every item one row at a time would take a while. My bad. &lt;/p&gt;
&lt;p&gt;Second, &lt;a href="http://www.celeryproject.org/"&gt;Celery&lt;/a&gt; broke again and that took me the better part of a day to detect and fix. As a central part of our infrastructure, this is really, &lt;em&gt;truly&lt;/em&gt; frustrating. The remainder of this post goes into what happened, why it happened and how I finally managed to fix it. &lt;/p&gt;
&lt;h2 id="why"&gt;Why?&lt;/h2&gt;
&lt;p&gt;First, why did this happen? Well…because I decided to log something. I created a task that processes &lt;a href="https://free.law/2014/10/31/announcing-oral-arguments-on-courtlistener/"&gt;our new audio files&lt;/a&gt; and I thought, “Hey, these should really log to the Juriscraper log rather than the usual celery log.” So, I added two lines to the file: One importing the log file and the second writing a log message. &lt;em&gt;This&lt;/em&gt; is the little change that brought Celery to a grinding halt. &lt;/p&gt;
&lt;h2 id="what-the-hell"&gt;What the Hell?&lt;/h2&gt;
&lt;p&gt;If you’re wondering why logging would break an entire system, well, the answer is because Celery runs as a different user than everything else. In our case, as the &lt;code&gt;celery&lt;/code&gt; user — a user that didn’t have permission to the log file I requested. Ugh. &lt;/p&gt;
&lt;p&gt;Fine, that’s not so bad, but there were a number of other frustrating things that made this much worse:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The Celery init script that we use was reporting the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="err"&gt;↪&lt;/span&gt; &lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt; &lt;span class="n"&gt;celeryd&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;
&lt;span class="n"&gt;celeryd&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;multi&lt;/span&gt; &lt;span class="n"&gt;v3&lt;/span&gt;&lt;span class="mf"&gt;.0.13&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Chiastic&lt;/span&gt; &lt;span class="n"&gt;Slide&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;nodes&lt;/span&gt;&lt;span class="p"&gt;...&lt;/span&gt;
    &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;w1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;courtlistener&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;OK&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But no, it was not starting “&lt;span class="caps"&gt;OK&lt;/span&gt;”. It was immediately crashing.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;No log messages…&lt;em&gt;anywhere&lt;/em&gt;. This appears to be because you have to detach &lt;code&gt;stdin&lt;/code&gt; and &lt;code&gt;stdout&lt;/code&gt; before daemonizing and according to asksol on &lt;span class="caps"&gt;IRC&lt;/span&gt;, this has been fixed in recent versions of Celery so even daemonizing errors can go to the Celery logs. Progress!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The collection of things that happens when &lt;code&gt;celery&lt;/code&gt; starts is complicated:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;I call &lt;code&gt;sudo service celeryd start&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;service&lt;/code&gt; calls &lt;code&gt;/etc/init.d/celeryd&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;celeryd&lt;/code&gt; does some stuff and calls &lt;code&gt;celery.sh&lt;/code&gt; (another file altogether), where our settings are.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;/strong&gt;: Apparently this is a CourtListener-specific customization, so this step probably won’t apply to you, but I have no idea where this wacky set up came from (it’s been in place for years).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Control is returned to &lt;code&gt;celery&lt;/code&gt;, which starts celery itself with a command generated from &lt;code&gt;celery.sh&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;On top of this, there’s a &lt;code&gt;celery&lt;/code&gt; binary and there’s a celery &lt;a href="https://docs.djangoproject.com/en/dev/howto/custom-management-commands/"&gt;management command&lt;/a&gt; for Django. (&lt;strong&gt;Update&lt;/strong&gt; the Django commands were removed in Celery 3.1. More progress!) &lt;code&gt;celery --help&lt;/code&gt; prints out 68 lines of documentation. Not too bad, but many of those lines refer you to other areas of the documentation. For example, &lt;code&gt;celery worker --help&lt;/code&gt; prints another 100 lines of help text. &lt;em&gt;Jesus&lt;/em&gt; this thing is complicated. &lt;/p&gt;
&lt;p&gt;Did I mention it has &lt;a href="http://seeknuance.com/2012/07/30/celery-api-changes-drive-me-nuts/"&gt;changing APIs&lt;/a&gt;?&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I digress a bit, but the point here is that it fails silently, there are no log messages when it fails, and there’s no way to know which part of a complicated infrastructure is the problem. End rant.&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h2 id="seeking-sanity"&gt;Seeking Sanity&lt;/h2&gt;
&lt;p&gt;It took me a long time to figure out what was going wrong, but I did eventually figure it out. The process, in case you run into something similar, is to modify &lt;code&gt;celeryd&lt;/code&gt; so it prints out the command that it eventually runs. At that point you’ll have the correct command. With that, you can run it as the &lt;code&gt;celery&lt;/code&gt; user and with some luck you’ll see what the problem is. There’s &lt;a href="http://stackoverflow.com/a/21883578/64911"&gt;a modified init script for this purpose, if you like&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Other tips:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;If you have a new enough version of Celery, there are &lt;a href="http://celery.readthedocs.org/en/latest/tutorials/daemonizing.html#troubleshooting"&gt;some troubleshooting tips&lt;/a&gt; that should help. They did nothing for me, because I haven’t upgraded yet for fear of the changing APIs.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There seem to be a handful of different command line flags that Celery can use to be sent to the background. You’ll need to disable these when you’re testing or else you won’t see error messages or anything (apparently?).&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="moving-forward"&gt;Moving Forward&lt;/h2&gt;
&lt;p&gt;So, I feel bad: I’ve ranted a good deal about Celery, but I haven’t proposed any solutions. It looks like a lot of things have been improved in recent versions of Celery, so part of the solution is likely for us to upgrade. &lt;/p&gt;
&lt;p&gt;But this isn’t the first time I’ve spent a long time trying to make Celery work, so what other ideas it take to make Celery a less complicated, more reliable tool? &lt;/p&gt;
&lt;p&gt;The ideas I’ve come up with so far are: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;More documentation for installation and set up troubleshooting with the possibility of a wiki.&lt;ul&gt;
&lt;li&gt;But already I rant about how much documentation it has.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;A simpler interface that eliminates a number of edge uses.&lt;ul&gt;
&lt;li&gt;But I have no idea what, if anything, can be eliminated. &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Support for fewer task brokers.&lt;ul&gt;
&lt;li&gt;But I use RabbitMQ and am considering switching to Redis.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;A more verbose, more thorough debug mode.&lt;ul&gt;
&lt;li&gt;But apparently this is already in place in the latest versions?&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Let Celery run as the &lt;code&gt;www-data&lt;/code&gt; user as a general practice?&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;But apparently that’s a bad idea. &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;/strong&gt; this is a bad idea in general, but it’s not &lt;em&gt;particularly&lt;/em&gt; bad if you don’t expose Celery on the network. If you’re only running it locally, you can probablly get by with Celery as a &lt;code&gt;www-data&lt;/code&gt; user or similar. &lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As you can tell, I don’t feel strongly that any of these are the right solution. I am convinced though that Celery has a bad smell and that it’s ripe for a leaner solution to fill some of its simpler use cases. I’m currently considering switching to a simpler task queue, but I don’t know that I’ll do it since Celery is the de-facto one for Django projects.&lt;/p&gt;
&lt;p&gt;We deserve a good, simple, reliable task queue though, and I wonder if there are good ideas for what could be changed in Celery to make that possible. I, for one, would love to never spend another minute trying to make RabbitMQ, Celery and my code play nicely together. &lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr/&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;In truth Celery is a classic love/hate relationship. On the one hand, it evokes posts like this one, but on the other, it allows me to send tasks to a background queue and distribute loads among many servers. Hell, it’s good enough for Instagram. On the other hand, god damn it, when it fails I go nuts. &lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;↩&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="Celery"></category><category term="Python"></category><category term="Rant"></category></entry></feed>