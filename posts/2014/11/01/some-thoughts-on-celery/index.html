<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Mike Lissner" />
        <meta name="copyright" content="Mike Lissner" />

        <link rel="author" href=https://plus.google.com/+MikeLissner />
        <meta name="twitter:creator" content="@mlissner">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Celery, Python, Rant, Tech, " />

<meta property="og:title" content="Some Thoughts on Celery  - A love-hate relationship "/>
<meta property="og:url" content="http://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/" />
<meta property="og:description" content="Celery drives me nuts. Celery allows background tasks. I hate Celery. I love Celery." />
<meta property="og:site_name" content="Michael Jay Lissner" />
<meta property="og:article:author" content="Mike Lissner" />
<meta property="og:article:published_time" content="2014-11-01T00:00:00-07:00" />
<meta name="twitter:title" content="Some Thoughts on Celery  - A love-hate relationship ">
<meta name="twitter:description" content="Celery drives me nuts. Celery allows background tasks. I hate Celery. I love Celery.">
<meta property="og:image" content="//localhost:8000/theme/images/apple-touch-icon-152x152.png" />
<meta name="twitter:image" content="//localhost:8000/theme/images/apple-touch-icon-152x152.png" >

        <title>Some Thoughts on Celery  - A love-hate relationship  · Michael Jay Lissner
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://michaeljaylissner.com/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://michaeljaylissner.com/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://michaeljaylissner.com/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://michaeljaylissner.com/theme/css/custom.css" media="screen">
        <link rel="shortcut icon" href="http://michaeljaylissner.com/theme/images/favicon.ico" type="image/x-icon" type="image/png" />
        <link rel="icon" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="http://michaeljaylissner.com/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="http://michaeljaylissner.com/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link href="http://michaeljaylissner.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Michael Jay Lissner - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-55828430-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://michaeljaylissner.com/"><span class=site-name>Michael Jay Lissner</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://michaeljaylissner.com">Home</a></li>
                                        <li ><a href="http://michaeljaylissner.com/about">About&nbsp;Site</a></li>
                                        <li ><a href="http://michaeljaylissner.com/contact">Contact</a></li>
                                        <li ><a href="http://michaeljaylissner.com/projects-and-papers">Projects <span class="amp">&amp;</span>&nbsp;Papers</a></li>
                            <li ><a href="http://michaeljaylissner.com/tags.html">Tags</a></li>
                            <li ><a href="http://michaeljaylissner.com/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://michaeljaylissner.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/"> Some Thoughts on&nbsp;Celery  <small> A love-hate relationship </small>  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#why">Why?</a></li>
<li><a href="#what-the-hell">What the Hell?</a></li>
<li><a href="#seeking-sanity">Seeking Sanity</a></li>
<li><a href="#moving-forward">Moving Forward</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            
<p>We finally upgraded <a href="https://www.courtlistener.com">CourtListener</a> last week and things went pretty well with the exception of two issues. First, we had some extended downtime as we waited for the database migration to complete. In retrospect, I should have realized that updating every item one row at a time would take a while. My bad. </p>
<p>Second, <a href="http://www.celeryproject.org/">Celery</a> broke again and that took me the better part of a day to detect and fix. As a central part of our infrastructure, this is really, <em>truly</em> frustrating. The remainder of this post goes into what happened, why it happened and how I finally managed to fix it. </p>
<h2 id="why">Why?</h2>
<p>First, why did this happen? Well…because I decided to log something. I created a task that processes <a href="https://free.law/2014/10/31/announcing-oral-arguments-on-courtlistener/">our new audio files</a> and I thought, “Hey, these should really log to the Juriscraper log rather than the usual celery log.” So, I added two lines to the file: One importing the log file and the second writing a log message. <em>This</em> is the little change that brought Celery to a grinding halt. </p>
<h2 id="what-the-hell">What the Hell?</h2>
<p>If you’re wondering why logging would break an entire system, well, the answer is because Celery runs as a different user than everything else. In our case, as the <code>celery</code> user — a user that didn’t have permission to the log file I requested. Ugh. </p>
<p>Fine, that’s not so bad, but there were a number of other frustrating things that made this much worse:</p>
<ol>
<li>
<p>The Celery init script that we use was reporting the following:</p>
<div class="highlight"><pre><span class="err">↪</span> <span class="n">sudo</span> <span class="n">service</span> <span class="n">celeryd</span> <span class="n">start</span>
<span class="n">celeryd</span><span class="o">-</span><span class="n">multi</span> <span class="n">v3</span><span class="mf">.0.13</span> <span class="p">(</span><span class="n">Chiastic</span> <span class="n">Slide</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">Starting</span> <span class="n">nodes</span><span class="p">...</span>
    <span class="o">&gt;</span> <span class="n">w1</span><span class="p">.</span><span class="n">courtlistener</span><span class="p">.</span><span class="n">com</span><span class="o">:</span> <span class="n">OK</span>
</pre></div>
<p>But no, it was not starting “<span class="caps">OK</span>”. It was immediately crashing.</p>
</li>
<li>
<p>No log messages…<em>anywhere</em>. This appears to be because you have to detach <code>stdin</code> and <code>stdout</code> before daemonizing and according to asksol on <span class="caps">IRC</span>, this has been fixed in recent versions of Celery so even daemonizing errors can go to the Celery logs. Progress!</p>
</li>
<li>
<p>The collection of things that happens when <code>celery</code> starts is complicated:</p>
<ol>
<li>
<p>I call <code>sudo service celeryd start</code></p>
</li>
<li>
<p><code>service</code> calls <code>/etc/init.d/celeryd</code></p>
</li>
<li>
<p><code>celeryd</code> does some stuff and calls <code>celery.sh</code> (another file altogether), where our settings are.</p>
<p><strong>Update</strong>: Apparently this is a CourtListener-specific customization, so this step probably won’t apply to you, but I have no idea where this wacky set up came from (it’s been in place for years).</p>
</li>
<li>
<p>Control is returned to <code>celery</code>, which starts celery itself with a command generated from <code>celery.sh</code>.</p>
</li>
</ol>
<p>On top of this, there’s a <code>celery</code> binary and there’s a celery <a href="https://docs.djangoproject.com/en/dev/howto/custom-management-commands/">management command</a> for Django. (<strong>Update</strong> the Django commands were removed in Celery 3.1. More progress!) <code>celery --help</code> prints out 68 lines of documentation. Not too bad, but many of those lines refer you to other areas of the documentation. For example, <code>celery worker --help</code> prints another 100 lines of help text. <em>Jesus</em> this thing is complicated. </p>
<p>Did I mention it has <a href="http://seeknuance.com/2012/07/30/celery-api-changes-drive-me-nuts/">changing APIs</a>?</p>
</li>
</ol>
<p>I digress a bit, but the point here is that it fails silently, there are no log messages when it fails, and there’s no way to know which part of a complicated infrastructure is the problem. End rant.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<h2 id="seeking-sanity">Seeking Sanity</h2>
<p>It took me a long time to figure out what was going wrong, but I did eventually figure it out. The process, in case you run into something similar, is to modify <code>celeryd</code> so it prints out the command that it eventually runs. At that point you’ll have the correct command. With that, you can run it as the <code>celery</code> user and with some luck you’ll see what the problem is. There’s <a href="http://stackoverflow.com/a/21883578/64911">a modified init script for this purpose, if you like</a>.</p>
<p>Other tips:</p>
<ol>
<li>
<p>If you have a new enough version of Celery, there are <a href="http://celery.readthedocs.org/en/latest/tutorials/daemonizing.html#troubleshooting">some troubleshooting tips</a> that should help. They did nothing for me, because I haven’t upgraded yet for fear of the changing APIs.</p>
</li>
<li>
<p>There seem to be a handful of different command line flags that Celery can use to be sent to the background. You’ll need to disable these when you’re testing or else you won’t see error messages or anything (apparently?).</p>
</li>
</ol>
<h2 id="moving-forward">Moving Forward</h2>
<p>So, I feel bad: I’ve ranted a good deal about Celery, but I haven’t proposed any solutions. It looks like a lot of things have been improved in recent versions of Celery, so part of the solution is likely for us to upgrade. </p>
<p>But this isn’t the first time I’ve spent a long time trying to make Celery work, so what other ideas it take to make Celery a less complicated, more reliable tool? </p>
<p>The ideas I’ve come up with so far are: </p>
<ul>
<li>More documentation for installation and set up troubleshooting with the possibility of a wiki.<ul>
<li>But already I rant about how much documentation it has.</li>
</ul>
</li>
<li>A simpler interface that eliminates a number of edge uses.<ul>
<li>But I have no idea what, if anything, can be eliminated. </li>
</ul>
</li>
<li>Support for fewer task brokers.<ul>
<li>But I use RabbitMQ and am considering switching to Redis.</li>
</ul>
</li>
<li>A more verbose, more thorough debug mode.<ul>
<li>But apparently this is already in place in the latest versions?</li>
</ul>
</li>
<li>Let Celery run as the <code>www-data</code> user as a general practice?<ul>
<li>
<p>But apparently that’s a bad idea. </p>
<p><strong>Update</strong> this is a bad idea in general, but it’s not <em>particularly</em> bad if you don’t expose Celery on the network. If you’re only running it locally, you can probablly get by with Celery as a <code>www-data</code> user or similar. </p>
</li>
</ul>
</li>
</ul>
<p>As you can tell, I don’t feel strongly that any of these are the right solution. I am convinced though that Celery has a bad smell and that it’s ripe for a leaner solution to fill some of its simpler use cases. I’m currently considering switching to a simpler task queue, but I don’t know that I’ll do it since Celery is the de-facto one for Django projects.</p>
<p>We deserve a good, simple, reliable task queue though, and I wonder if there are good ideas for what could be changed in Celery to make that possible. I, for one, would love to never spend another minute trying to make RabbitMQ, Celery and my code play nicely together. </p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>In truth Celery is a classic love/hate relationship. On the one hand, it evokes posts like this one, but on the other, it allows me to send tasks to a background queue and distribute loads among many servers. Hell, it’s good enough for Instagram. On the other hand, god damn it, when it fails I go nuts. <a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            
            <section>
<p id="comment-message">I love getting feedback and comments. Make my day by making a comment. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'michaeljaylissner';
        var disqus_identifier = 'http://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/';
    var disqus_url = 'http://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="http://michaeljaylissner.com/posts/2014/10/14/becoming-a-non-profit/" title="Previous: Creating a Non-Profit - An incantation to make California and the IRS grant your organization tax exempt status">Creating a Non-Profit <small>An incantation to make California and the IRS grant your organization tax exempt status</small></a></li>
                <li class="next-article"><a href="http://michaeljaylissner.com/posts/2014/11/06/updating-bulk-data-in-courtlistener-more/" title="Next: Updating Bulk Data in CourtListener…Again - Can You Do it Faster?">Updating Bulk Data in CourtListener…Again <small>Can You Do it Faster?</small></a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-11-01T00:00:00-07:00">Nov 1, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="http://michaeljaylissner.com/categories.html#tech-ref">Tech</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://michaeljaylissner.com/tags.html#celery-ref">Celery
                    <span>1</span>
</a></li>
                <li><a href="http://michaeljaylissner.com/tags.html#python-ref">Python
                    <span>9</span>
</a></li>
                <li><a href="http://michaeljaylissner.com/tags.html#rant-ref">Rant
                    <span>6</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://twitter.com/mlissner" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="http://github.com/mlissner" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="mailto:mlissner+blog@michaeljaylissner.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
<h4>This is Reader-Editable</h4>
<a href="https://github.com/mlissner/michaeljaylissner.com/edit/master/content/some-thoughts-on-celery.md">
    <i class="fa fa-github"></i>
    Edit this post on Github
</a><!-- Begin MailChimp Signup Form -->
<div id="mc-embed-signup">
<form action="//asdf.us2.list-manage.com/subscribe/post?u=87204b44efb46f0fd27b95167&amp;id=f511375e11" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
<h4>Get Weekly Updates</h4>
<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Enter your email..." required>
<div class="clear"><input type="submit" value="Send Me Updates" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
</form>
</div>
<!--End mc_embed_signup-->
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Unless mentioned otherwise, all material on this site is <a href="about#license">licensed</a> under a Creative Commons copyright or the GNU Affero GPL. <a href="about#privacy">Privacy Policy</a>.</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'michaeljaylissner';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>